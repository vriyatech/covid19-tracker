{"ast":null,"code":"var _jsxFileName = \"D:\\\\programming\\\\react\\\\new covid\\\\covid19\\\\src\\\\components\\\\Map.js\";\nimport React, { Component, Fragment } from 'react';\nimport { ComposableMap, ZoomableGroup, Geographies, Geography, Marker, Line } from 'react-simple-maps';\nimport { scaleSequential, scaleLog, scaleLinear } from 'd3-scale';\nimport { interpolateMagma } from 'd3-scale-chromatic';\nimport { PatternLines } from '@vx/pattern';\nimport { isMobile, isIPad13 } from 'react-device-detect';\nimport { TinyColor } from '@ctrl/tinycolor';\nimport { FaShip } from 'react-icons/fa';\nimport Toggle from 'react-toggle';\nimport 'react-toggle/style.css';\nimport maps from '../data/maps.yml';\nimport us_map from '../data/us_map.yml';\nimport transmissions from '../data/transmissions.yml';\nimport coord from '../data/transmissions_coord.yml';\nimport { getDataFromRegion, parseDate } from '../utils/utils';\nimport * as str from '../utils/strings';\nimport i18n from '../data/i18n.yml';\n\nclass Map extends Component {\n  constructor(...args) {\n    super(...args);\n    this.state = {\n      loaded: false,\n      cursor: [0, 0],\n      clicked: false,\n      showTransmissions: false,\n      usState: null\n    };\n\n    this.handleGeographyClick = region => () => {\n      if (!this.state.clicked || region == null) return;\n      this.props.regionToggle(region.split('.'));\n    };\n\n    this.onZoomEnd = (event, state) => {\n      this.props.handleMapZoomChange(state.zoom);\n    };\n\n    this.getConfig = (config, defaultConfig) => config != null ? config.split(',').map(d => parseInt(d, 10)) : defaultConfig;\n\n    this.getColorScale = isUsState => {\n      const {\n        data,\n        currentRegion,\n        scale,\n        metric,\n        darkMode\n      } = this.props;\n      const currentMap = maps[this.props.currentMap];\n      const currentScale = scale === 'linear' ? scaleLinear : scaleLog;\n      let maxCount = currentMap[`maxScale_${metric}`];\n\n      if (isUsState && metric === 'confirmedCount') {\n        const stateData = getDataFromRegion(data, currentRegion.slice(0, 2));\n        maxCount = Math.max(...Object.keys(stateData).filter(x => !['confirmedCount', 'curedCount', 'deadCount', 'ENGLISH'].includes(x)).map(county => Math.max(...Object.values(stateData[county][metric]))));\n      }\n\n      const mapScale = currentScale().domain([1, maxCount]).clamp(true);\n\n      const colorConvert = x => darkMode ? x * 0.95 + 0.05 : 0.95 - x * 0.95;\n\n      const colorScale = scaleSequential(d => {\n        if (!this.state.showTransmissions || this.props.currentMap !== str.WORLD_MAP) {\n          const color = new TinyColor(interpolateMagma(colorConvert(mapScale(d))));\n          if (!darkMode) return color.toRgbString();\n          return color.desaturate(10).toRgbString();\n        } else {\n          const greyedColor = new TinyColor(interpolateMagma(colorConvert(mapScale(d)))).desaturate(100);\n          if (!darkMode) return greyedColor.setAlpha(0.6).toRgbString(); // make the colors distinguishable from dark background\n\n          return greyedColor.getLuminance() < 0.09 ? greyedColor.darken(5).setAlpha(0.9).toRgbString() : greyedColor.lighten(5).setAlpha(0.9).toRgbString();\n        }\n      });\n      return {\n        colorScale,\n        mapScale\n      };\n    };\n\n    this.getStrokeColor = (counts, isUsState) => {\n      const {\n        colorScale,\n        mapScale\n      } = this.getColorScale(isUsState);\n      const {\n        darkMode\n      } = this.props;\n      const tinyColor = new TinyColor(colorScale(counts));\n\n      if (!darkMode) {\n        return tinyColor.isDark() ? colorScale(mapScale.invert(mapScale(counts) - 0.6)) : colorScale(mapScale.invert(mapScale(counts) + 0.3));\n      } else {\n        return tinyColor.isDark() ? colorScale(mapScale.invert(mapScale(counts) + 0.5)) : colorScale(mapScale.invert(mapScale(counts) - 0.5));\n      }\n    };\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (this.props.currentMap !== prevProps.currentMap || this.state.usState !== prevState.usState) {\n      this.setState({\n        loaded: false\n      });\n      setTimeout(() => {\n        this.props.tooltipRebuild();\n      }, 100);\n    }\n\n    if (this.props.currentMap === str.US_MAP2) {\n      const usState = this.props.currentRegion[1];\n\n      if (usState !== this.state.usState) {\n        this.setState({\n          usState\n        });\n      }\n    }\n  }\n\n  render() {\n    if (this.props.currentMap === str.TRANSMISSION) return /*#__PURE__*/React.createElement(\"div\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 111,\n        columnNumber: 64\n      }\n    });\n    const currentMap = maps[this.props.currentMap];\n    const {\n      data,\n      metric,\n      date,\n      lang,\n      currentRegion,\n      mapZoom,\n      darkMode\n    } = this.props;\n    const isUsState = this.props.currentMap === str.US_MAP2 && this.state.usState != null && this.state.usState in us_map;\n    const center = isUsState ? us_map[this.state.usState].center.split(',').map(d => parseFloat(d)) : currentMap.center.split(',').map(d => parseFloat(d));\n    const scale = isUsState ? us_map[this.state.usState].scale : currentMap.scale;\n    const projection = isUsState ? 'geoMercator' : currentMap.projection;\n    const {\n      colorScale\n    } = this.getColorScale(isUsState);\n    const cruiseData = getDataFromRegion(data, [str.INTL_CONVEYANCE_ZH, str.DIAMOND_PRINCESS_ZH]);\n    const cruiseCounts = cruiseData[metric][date] ? cruiseData[metric][date] : 0;\n    const cruiseStrokeColor = this.getStrokeColor(cruiseCounts, isUsState);\n    const greyStrokeColor = darkMode ? 'var(--primary-color-10)' : 'var(--grey)';\n    return /*#__PURE__*/React.createElement(Fragment, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 132,\n        columnNumber: 13\n      }\n    }, this.props.currentMap === str.WORLD_MAP && /*#__PURE__*/React.createElement(\"div\", {\n      className: \"map-transmission-toggle-wrap\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 134,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(Toggle, {\n      className: \"map-transmission-toggle\",\n      defaultChecked: this.state.showTransmissions,\n      onChange: () => this.setState({\n        showTransmissions: !this.state.showTransmissions\n      }),\n      icons: false,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 135,\n        columnNumber: 25\n      }\n    }), /*#__PURE__*/React.createElement(\"span\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 141,\n        columnNumber: 25\n      }\n    }, i18n.TRANSMISSIONS[this.props.lang])), /*#__PURE__*/React.createElement(ComposableMap, {\n      projection: projection,\n      projectionConfig: {\n        scale: scale,\n        rotate: currentMap.rotate ? currentMap.rotate.split(',').map(x => parseInt(x, 10)) : [0, 0, 0],\n        parallels: [0, 0]\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 144,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(PatternLines, {\n      id: \"lines\",\n      height: 6,\n      width: 6,\n      stroke: greyStrokeColor,\n      strokeWidth: 1,\n      background: darkMode ? 'var(--darker-grey)' : '#fff',\n      orientation: ['diagonal'],\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 154,\n        columnNumber: 21\n      }\n    }), /*#__PURE__*/React.createElement(PatternLines, {\n      id: \"background-lines\",\n      height: 6,\n      width: 6,\n      stroke: darkMode ? '#333' : '#ddd',\n      strokeWidth: 1,\n      background: darkMode ? 'var(--darker-grey)' : '#fff',\n      orientation: ['diagonal'],\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 163,\n        columnNumber: 21\n      }\n    }), /*#__PURE__*/React.createElement(ZoomableGroup, {\n      zoom: mapZoom,\n      onZoomEnd: this.onZoomEnd,\n      onMoveStart: (e, m) => this.setState({\n        cursor: [m.x, m.y],\n        clicked: false\n      }),\n      onMoveEnd: (e, m) => {\n        // click on desktop\n        if (Math.abs(m.x - this.state.cursor[0]) < 1 && Math.abs(m.y - this.state.cursor[1]) < 1) this.setState({\n          clicked: true\n        });\n      },\n      onTouchStart: // click on touch screens\n      isMobile || isIPad13 ? () => this.setState({\n        clicked: true\n      }) : null,\n      center: center,\n      minZoom: 0.2,\n      maxZoom: 5,\n      disableZooming: isMobile || isIPad13,\n      disablePanning: isMobile || isIPad13,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 172,\n        columnNumber: 21\n      }\n    }, ![str.WORLD_MAP, str.US_MAP].includes(this.props.currentMap) && /*#__PURE__*/React.createElement(Geographies, {\n      geography: `maps/${this.props.currentMap !== str.US_MAP2 ? 'world-50m' : 'states-10m'}.json`,\n      onMouseEnter: () => {\n        if (!this.state.loaded) {\n          this.setState({\n            loaded: true\n          });\n          this.props.tooltipRebuild();\n        }\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 192,\n        columnNumber: 29\n      }\n    }, ({\n      geographies\n    }) => geographies.map(geo => {\n      let counts = 0;\n\n      if (geo.properties.REGION != null) {\n        const region = getDataFromRegion(data, geo.properties.REGION.split('.'));\n        if (region && region[metric] && region[metric][date]) counts = region[metric][date];\n      }\n\n      const backgroundMap = this.props.currentMap !== str.US_MAP2 ? str.WORLD_MAP : str.US_MAP;\n      const name = geo.properties[maps[backgroundMap].name_key[lang]];\n      const isCurrentCountryOrState = backgroundMap === str.WORLD_MAP ? geo.properties.CHINESE_NAME === currentRegion[0] : geo.properties.CHINESE_NAME === currentRegion[1];\n      if (isCurrentCountryOrState) return /*#__PURE__*/React.createElement(\"div\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 218,\n          columnNumber: 77\n        }\n      });\n      if (backgroundMap === str.US_MAP && currentRegion.length === 1) return /*#__PURE__*/React.createElement(\"div\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 219,\n          columnNumber: 112\n        }\n      });\n      return /*#__PURE__*/React.createElement(Geography, {\n        className: \"map-geography\",\n        key: geo.rsmKey,\n        geography: geo,\n        \"data-tip\": `${name} <span class=\"plot-tooltip-bold\">${counts}</span>`,\n        style: {\n          default: {\n            fill: darkMode ? 'var(--darker-grey)' : '#fff',\n            stroke: darkMode ? '#333' : '#ddd',\n            strokeWidth: 2\n          },\n          hover: {\n            fill: `url(\"#background-lines\") ${darkMode ? '#333' : '#ddd'}`,\n            stroke: darkMode ? '#333' : '#ddd',\n            strokeWidth: 2,\n            cursor: counts > 0 ? 'pointer' : 'default'\n          },\n          pressed: {\n            fill: `url(\"#background-lines\") ${darkMode ? '#333' : '#ddd'}`,\n            stroke: darkMode ? '#333' : '#ddd',\n            strokeWidth: 2,\n            cursor: counts > 0 ? 'pointer' : 'default'\n          }\n        },\n        onClick: this.handleGeographyClick(geo.properties.REGION),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 221,\n          columnNumber: 45\n        }\n      });\n    })), /*#__PURE__*/React.createElement(Geographies, {\n      geography: `maps/${currentMap.filename}`,\n      onMouseEnter: () => {\n        if (!this.state.loaded) {\n          this.setState({\n            loaded: true\n          });\n          this.props.tooltipRebuild();\n        }\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 251,\n        columnNumber: 25\n      }\n    }, ({\n      geographies\n    }) => geographies.map((geo, i) => {\n      let counts = 0;\n\n      if (geo.properties.REGION != null) {\n        const region = getDataFromRegion(data, geo.properties.REGION.split('.'));\n        if (region && region[metric] && region[metric][date]) counts = region[metric][date];\n      }\n\n      const name = geo.properties[currentMap.name_key[lang]];\n      let isCurrentRegion = geo.properties[currentMap.name_key.zh] === currentRegion[currentRegion.length - 1];\n      if (currentMap.parent_key) isCurrentRegion = isCurrentRegion && geo.properties[currentMap.parent_key] === currentRegion[currentRegion.length - 2]; // highlight all cities in the province\n\n      let isParentRegion = false;\n\n      if (currentMap.parent_key) {\n        isParentRegion = geo.properties[currentMap.parent_key] === currentRegion[currentRegion.length - 1];\n        if (currentRegion.length >= 3) isParentRegion = isParentRegion || geo.properties[currentMap.parent_key] === currentRegion[currentRegion.length - 2];\n        if (currentRegion.length === 1 || currentRegion[currentRegion.length - 1] === str.MAINLAND_CHINA_ZH) isParentRegion = true;\n        isParentRegion = isParentRegion || isCurrentRegion;\n      } else {\n        isParentRegion = true;\n      }\n\n      const strokeColor = counts === 0 ? greyStrokeColor : this.getStrokeColor(counts, isUsState); // US map\n\n      if (this.props.currentMap === str.US_MAP2 && !isParentRegion) return /*#__PURE__*/React.createElement(\"div\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 303,\n          columnNumber: 106\n        }\n      });\n      return /*#__PURE__*/React.createElement(Fragment, {\n        key: `fragment-${geo.rsmKey}`,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 306,\n          columnNumber: 41\n        }\n      }, /*#__PURE__*/React.createElement(Geography, {\n        key: geo.rsmKey,\n        className: \"map-geography\",\n        geography: geo,\n        \"data-tip\": `${name} <span class=\"plot-tooltip-bold\">${counts}</span>`,\n        style: {\n          default: {\n            fill: isCurrentRegion ? `url(\"#highlightLines-${i}\") ${greyStrokeColor}` : counts > 0 ? colorScale(counts) : 'url(\"#lines\")',\n            stroke: strokeColor,\n            strokeWidth: isCurrentRegion ? 1 : 0,\n            opacity: isParentRegion ? 1 : 0.2\n          },\n          hover: {\n            fill: `url(\"#highlightLines-${i}\") ${greyStrokeColor}`,\n            strokeWidth: 1,\n            stroke: strokeColor,\n            cursor: counts > 0 ? 'pointer' : 'default'\n          },\n          pressed: {\n            fill: `url(\"#highlightLines-${i}\") ${greyStrokeColor}`,\n            strokeWidth: 1,\n            stroke: strokeColor,\n            cursor: counts > 0 ? 'pointer' : 'default'\n          }\n        },\n        onClick: this.handleGeographyClick(geo.properties.REGION),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 307,\n          columnNumber: 45\n        }\n      }), /*#__PURE__*/React.createElement(PatternLines, {\n        id: `highlightLines-${i}`,\n        height: 6,\n        width: 6,\n        stroke: strokeColor,\n        strokeWidth: 1,\n        background: counts !== 0 ? colorScale(counts) : darkMode ? 'var(--darker-grey)' : '#fff',\n        orientation: ['diagonal'],\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 336,\n          columnNumber: 45\n        }\n      }));\n    })), this.props.currentMap === str.WORLD_MAP && this.state.showTransmissions && transmissions.filter(trans => parseDate(trans.date) <= parseDate(date)).map((trans, i) => {\n      return /*#__PURE__*/React.createElement(Line, {\n        keys: `transmission-${i}`,\n        from: coord[trans.from].split(',').map(c => parseFloat(c)),\n        to: coord[trans.to].split(',').map(c => parseFloat(c)),\n        stroke: darkMode ? 'rgba(222,73,104,0.9)' : 'rgba(222, 73, 104, 0.5)',\n        strokeWidth: 1,\n        strokeLinecap: \"round\",\n        style: {\n          pointerEvents: 'none'\n        },\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 363,\n          columnNumber: 41\n        }\n      });\n    }), [str.WORLD_MAP, str.CHINA_MAP1, str.CHINA_MAP2].includes(this.props.currentMap) && /*#__PURE__*/React.createElement(Marker, {\n      key: 'wuhan',\n      coordinates: [114.2, 30.3],\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 377,\n        columnNumber: 29\n      }\n    }, /*#__PURE__*/React.createElement(\"g\", {\n      fill: \"none\",\n      stroke: \"var(--primary-color-4)\",\n      strokeWidth: \"2\",\n      pointerEvents: \"none\",\n      strokeLinecap: \"round\",\n      strokeLinejoin: \"round\",\n      transform: \"translate(-12, -24)\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 378,\n        columnNumber: 33\n      }\n    }, /*#__PURE__*/React.createElement(\"circle\", {\n      cx: \"12\",\n      cy: \"10\",\n      r: \"3\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 387,\n        columnNumber: 37\n      }\n    }), /*#__PURE__*/React.createElement(\"path\", {\n      d: \"M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 388,\n        columnNumber: 37\n      }\n    }))), (this.props.currentMap === str.WORLD_MAP || this.props.currentMap === str.JAPAN_MAP) && /*#__PURE__*/React.createElement(Marker, {\n      key: 'diamond-princess',\n      coordinates: [139.6, 35.4],\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 393,\n        columnNumber: 29\n      }\n    }, /*#__PURE__*/React.createElement(FaShip, {\n      size: this.props.currentMap === str.WORLD_MAP ? 18 : 36,\n      color: colorScale(cruiseCounts),\n      className: \"map-ship\",\n      \"data-tip\": `${lang === 'zh' ? str.DIAMOND_PRINCESS_ZH : cruiseData.ENGLISH} <span class=\"plot-tooltip-bold\">${cruiseCounts}</span>`,\n      style: {\n        stroke: cruiseStrokeColor,\n        visibility: cruiseCounts > 0 ? 'visible' : 'hidden',\n        strokeWidth: currentRegion[currentRegion.length - 1] === str.DIAMOND_PRINCESS_ZH ? 30 : 0\n      },\n      onClick: () => this.props.regionToggle([str.INTL_CONVEYANCE_ZH, str.DIAMOND_PRINCESS_ZH]),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 394,\n        columnNumber: 33\n      }\n    })))));\n  }\n\n}\n\nexport default Map;","map":{"version":3,"sources":["D:/programming/react/new covid/covid19/src/components/Map.js"],"names":["React","Component","Fragment","ComposableMap","ZoomableGroup","Geographies","Geography","Marker","Line","scaleSequential","scaleLog","scaleLinear","interpolateMagma","PatternLines","isMobile","isIPad13","TinyColor","FaShip","Toggle","maps","us_map","transmissions","coord","getDataFromRegion","parseDate","str","i18n","Map","state","loaded","cursor","clicked","showTransmissions","usState","handleGeographyClick","region","props","regionToggle","split","onZoomEnd","event","handleMapZoomChange","zoom","getConfig","config","defaultConfig","map","d","parseInt","getColorScale","isUsState","data","currentRegion","scale","metric","darkMode","currentMap","currentScale","maxCount","stateData","slice","Math","max","Object","keys","filter","x","includes","county","values","mapScale","domain","clamp","colorConvert","colorScale","WORLD_MAP","color","toRgbString","desaturate","greyedColor","setAlpha","getLuminance","darken","lighten","getStrokeColor","counts","tinyColor","isDark","invert","componentDidUpdate","prevProps","prevState","setState","setTimeout","tooltipRebuild","US_MAP2","render","TRANSMISSION","date","lang","mapZoom","center","parseFloat","projection","cruiseData","INTL_CONVEYANCE_ZH","DIAMOND_PRINCESS_ZH","cruiseCounts","cruiseStrokeColor","greyStrokeColor","TRANSMISSIONS","rotate","parallels","e","m","y","abs","US_MAP","geographies","geo","properties","REGION","backgroundMap","name","name_key","isCurrentCountryOrState","CHINESE_NAME","length","rsmKey","default","fill","stroke","strokeWidth","hover","pressed","filename","i","isCurrentRegion","zh","parent_key","isParentRegion","MAINLAND_CHINA_ZH","strokeColor","opacity","trans","from","c","to","pointerEvents","CHINA_MAP1","CHINA_MAP2","JAPAN_MAP","ENGLISH","visibility"],"mappings":"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","sourcesContent":["import React, { Component, Fragment } from 'react'\r\nimport { ComposableMap, ZoomableGroup, Geographies, Geography, Marker, Line } from 'react-simple-maps'\r\nimport { scaleSequential, scaleLog, scaleLinear } from 'd3-scale'\r\nimport { interpolateMagma } from 'd3-scale-chromatic'\r\nimport { PatternLines } from '@vx/pattern'\r\nimport { isMobile, isIPad13 } from 'react-device-detect'\r\nimport { TinyColor } from '@ctrl/tinycolor'\r\nimport { FaShip } from 'react-icons/fa'\r\nimport Toggle from 'react-toggle'\r\nimport 'react-toggle/style.css'\r\nimport maps from '../data/maps.yml'\r\nimport us_map from '../data/us_map.yml'\r\nimport transmissions from '../data/transmissions.yml'\r\nimport coord from '../data/transmissions_coord.yml'\r\nimport { getDataFromRegion, parseDate } from '../utils/utils'\r\nimport * as str from '../utils/strings'\r\nimport i18n from '../data/i18n.yml'\r\n\r\nclass Map extends Component {\r\n    state = {\r\n        loaded: false,\r\n        cursor: [ 0, 0 ],\r\n        clicked: false,\r\n        showTransmissions: false,\r\n        usState: null\r\n    }\r\n\r\n    componentDidUpdate(prevProps, prevState) {\r\n        if (this.props.currentMap !== prevProps.currentMap || this.state.usState !== prevState.usState) {\r\n            this.setState({ loaded: false })\r\n            setTimeout(() => {\r\n                this.props.tooltipRebuild()\r\n            }, 100)\r\n        }\r\n\r\n        if (this.props.currentMap === str.US_MAP2) {\r\n            const usState = this.props.currentRegion[1]\r\n            if (usState !== this.state.usState) {\r\n                this.setState({ usState })\r\n            }\r\n        }\r\n    }\r\n\r\n    handleGeographyClick = (region) => () => {\r\n        if (!this.state.clicked || region == null) return\r\n\r\n        this.props.regionToggle(region.split('.'))\r\n    }\r\n\r\n    onZoomEnd = (event, state) => {\r\n        this.props.handleMapZoomChange(state.zoom)\r\n    }\r\n\r\n    getConfig = (config, defaultConfig) =>\r\n        config != null ? config.split(',').map((d) => parseInt(d, 10)) : defaultConfig\r\n\r\n    getColorScale = (isUsState) => {\r\n        const { data, currentRegion, scale, metric, darkMode } = this.props\r\n        const currentMap = maps[this.props.currentMap]\r\n\r\n        const currentScale = scale === 'linear' ? scaleLinear : scaleLog\r\n\r\n        let maxCount = currentMap[`maxScale_${metric}`]\r\n        if (isUsState && metric === 'confirmedCount') {\r\n            const stateData = getDataFromRegion(data, currentRegion.slice(0, 2))\r\n            maxCount = Math.max(\r\n                ...Object.keys(stateData)\r\n                    .filter((x) => ![ 'confirmedCount', 'curedCount', 'deadCount', 'ENGLISH' ].includes(x))\r\n                    .map((county) => Math.max(...Object.values(stateData[county][metric])))\r\n            )\r\n        }\r\n        const mapScale = currentScale().domain([ 1, maxCount ]).clamp(true)\r\n        const colorConvert = (x) => (darkMode ? x * 0.95 + 0.05 : 0.95 - x * 0.95)\r\n        const colorScale = scaleSequential((d) => {\r\n            if (!this.state.showTransmissions || this.props.currentMap !== str.WORLD_MAP) {\r\n                const color = new TinyColor(interpolateMagma(colorConvert(mapScale(d))))\r\n                if (!darkMode) return color.toRgbString()\r\n\r\n                return color.desaturate(10).toRgbString()\r\n            } else {\r\n                const greyedColor = new TinyColor(interpolateMagma(colorConvert(mapScale(d)))).desaturate(100)\r\n                if (!darkMode) return greyedColor.setAlpha(0.6).toRgbString()\r\n\r\n                // make the colors distinguishable from dark background\r\n                return greyedColor.getLuminance() < 0.09\r\n                    ? greyedColor.darken(5).setAlpha(0.9).toRgbString()\r\n                    : greyedColor.lighten(5).setAlpha(0.9).toRgbString()\r\n            }\r\n        })\r\n\r\n        return { colorScale, mapScale }\r\n    }\r\n\r\n    getStrokeColor = (counts, isUsState) => {\r\n        const { colorScale, mapScale } = this.getColorScale(isUsState)\r\n        const { darkMode } = this.props\r\n        const tinyColor = new TinyColor(colorScale(counts))\r\n\r\n        if (!darkMode) {\r\n            return tinyColor.isDark()\r\n                ? colorScale(mapScale.invert(mapScale(counts) - 0.6))\r\n                : colorScale(mapScale.invert(mapScale(counts) + 0.3))\r\n        } else {\r\n            return tinyColor.isDark()\r\n                ? colorScale(mapScale.invert(mapScale(counts) + 0.5))\r\n                : colorScale(mapScale.invert(mapScale(counts) - 0.5))\r\n        }\r\n    }\r\n\r\n    render() {\r\n        if (this.props.currentMap === str.TRANSMISSION) return <div />\r\n\r\n        const currentMap = maps[this.props.currentMap]\r\n        const { data, metric, date, lang, currentRegion, mapZoom, darkMode } = this.props\r\n\r\n        const isUsState =\r\n            this.props.currentMap === str.US_MAP2 && this.state.usState != null && this.state.usState in us_map\r\n        const center = isUsState\r\n            ? us_map[this.state.usState].center.split(',').map((d) => parseFloat(d))\r\n            : currentMap.center.split(',').map((d) => parseFloat(d))\r\n        const scale = isUsState ? us_map[this.state.usState].scale : currentMap.scale\r\n        const projection = isUsState ? 'geoMercator' : currentMap.projection\r\n\r\n        const { colorScale } = this.getColorScale(isUsState)\r\n        const cruiseData = getDataFromRegion(data, [ str.INTL_CONVEYANCE_ZH, str.DIAMOND_PRINCESS_ZH ])\r\n        const cruiseCounts = cruiseData[metric][date] ? cruiseData[metric][date] : 0\r\n\r\n        const cruiseStrokeColor = this.getStrokeColor(cruiseCounts, isUsState)\r\n        const greyStrokeColor = darkMode ? 'var(--primary-color-10)' : 'var(--grey)'\r\n\r\n        return (\r\n            <Fragment>\r\n                {this.props.currentMap === str.WORLD_MAP && (\r\n                    <div className=\"map-transmission-toggle-wrap\">\r\n                        <Toggle\r\n                            className=\"map-transmission-toggle\"\r\n                            defaultChecked={this.state.showTransmissions}\r\n                            onChange={() => this.setState({ showTransmissions: !this.state.showTransmissions })}\r\n                            icons={false}\r\n                        />\r\n                        <span>{i18n.TRANSMISSIONS[this.props.lang]}</span>\r\n                    </div>\r\n                )}\r\n                <ComposableMap\r\n                    projection={projection}\r\n                    projectionConfig={{\r\n                        scale: scale,\r\n                        rotate: currentMap.rotate\r\n                            ? currentMap.rotate.split(',').map((x) => parseInt(x, 10))\r\n                            : [ 0, 0, 0 ],\r\n                        parallels: [ 0, 0 ]\r\n                    }}\r\n                >\r\n                    <PatternLines\r\n                        id=\"lines\"\r\n                        height={6}\r\n                        width={6}\r\n                        stroke={greyStrokeColor}\r\n                        strokeWidth={1}\r\n                        background={darkMode ? 'var(--darker-grey)' : '#fff'}\r\n                        orientation={[ 'diagonal' ]}\r\n                    />\r\n                    <PatternLines\r\n                        id=\"background-lines\"\r\n                        height={6}\r\n                        width={6}\r\n                        stroke={darkMode ? '#333' : '#ddd'}\r\n                        strokeWidth={1}\r\n                        background={darkMode ? 'var(--darker-grey)' : '#fff'}\r\n                        orientation={[ 'diagonal' ]}\r\n                    />\r\n                    <ZoomableGroup\r\n                        zoom={mapZoom}\r\n                        onZoomEnd={this.onZoomEnd}\r\n                        onMoveStart={(e, m) => this.setState({ cursor: [ m.x, m.y ], clicked: false })}\r\n                        onMoveEnd={(e, m) => {\r\n                            // click on desktop\r\n                            if (Math.abs(m.x - this.state.cursor[0]) < 1 && Math.abs(m.y - this.state.cursor[1]) < 1)\r\n                                this.setState({ clicked: true })\r\n                        }}\r\n                        onTouchStart={\r\n                            // click on touch screens\r\n                            isMobile || isIPad13 ? () => this.setState({ clicked: true }) : null\r\n                        }\r\n                        center={center}\r\n                        minZoom={0.2}\r\n                        maxZoom={5}\r\n                        disableZooming={isMobile || isIPad13}\r\n                        disablePanning={isMobile || isIPad13}\r\n                    >\r\n                        {![ str.WORLD_MAP, str.US_MAP ].includes(this.props.currentMap) && (\r\n                            <Geographies\r\n                                geography={`maps/${this.props.currentMap !== str.US_MAP2\r\n                                    ? 'world-50m'\r\n                                    : 'states-10m'}.json`}\r\n                                onMouseEnter={() => {\r\n                                    if (!this.state.loaded) {\r\n                                        this.setState({ loaded: true })\r\n                                        this.props.tooltipRebuild()\r\n                                    }\r\n                                }}\r\n                            >\r\n                                {({ geographies }) =>\r\n                                    geographies.map((geo) => {\r\n                                        let counts = 0\r\n                                        if (geo.properties.REGION != null) {\r\n                                            const region = getDataFromRegion(data, geo.properties.REGION.split('.'))\r\n                                            if (region && region[metric] && region[metric][date])\r\n                                                counts = region[metric][date]\r\n                                        }\r\n                                        const backgroundMap =\r\n                                            this.props.currentMap !== str.US_MAP2 ? str.WORLD_MAP : str.US_MAP\r\n                                        const name = geo.properties[maps[backgroundMap].name_key[lang]]\r\n                                        const isCurrentCountryOrState =\r\n                                            backgroundMap === str.WORLD_MAP\r\n                                                ? geo.properties.CHINESE_NAME === currentRegion[0]\r\n                                                : geo.properties.CHINESE_NAME === currentRegion[1]\r\n                                        if (isCurrentCountryOrState) return <div />\r\n                                        if (backgroundMap === str.US_MAP && currentRegion.length === 1) return <div />\r\n                                        return (\r\n                                            <Geography\r\n                                                className=\"map-geography\"\r\n                                                key={geo.rsmKey}\r\n                                                geography={geo}\r\n                                                data-tip={`${name} <span class=\"plot-tooltip-bold\">${counts}</span>`}\r\n                                                style={{\r\n                                                    default: {\r\n                                                        fill: darkMode ? 'var(--darker-grey)' : '#fff',\r\n                                                        stroke: darkMode ? '#333' : '#ddd',\r\n                                                        strokeWidth: 2\r\n                                                    },\r\n                                                    hover: {\r\n                                                        fill: `url(\"#background-lines\") ${darkMode ? '#333' : '#ddd'}`,\r\n                                                        stroke: darkMode ? '#333' : '#ddd',\r\n                                                        strokeWidth: 2,\r\n                                                        cursor: counts > 0 ? 'pointer' : 'default'\r\n                                                    },\r\n                                                    pressed: {\r\n                                                        fill: `url(\"#background-lines\") ${darkMode ? '#333' : '#ddd'}`,\r\n                                                        stroke: darkMode ? '#333' : '#ddd',\r\n                                                        strokeWidth: 2,\r\n                                                        cursor: counts > 0 ? 'pointer' : 'default'\r\n                                                    }\r\n                                                }}\r\n                                                onClick={this.handleGeographyClick(geo.properties.REGION)}\r\n                                            />\r\n                                        )\r\n                                    })}\r\n                            </Geographies>\r\n                        )}\r\n                        <Geographies\r\n                            geography={`maps/${currentMap.filename}`}\r\n                            onMouseEnter={() => {\r\n                                if (!this.state.loaded) {\r\n                                    this.setState({ loaded: true })\r\n                                    this.props.tooltipRebuild()\r\n                                }\r\n                            }}\r\n                        >\r\n                            {({ geographies }) =>\r\n                                geographies.map((geo, i) => {\r\n                                    let counts = 0\r\n                                    if (geo.properties.REGION != null) {\r\n                                        const region = getDataFromRegion(data, geo.properties.REGION.split('.'))\r\n                                        if (region && region[metric] && region[metric][date])\r\n                                            counts = region[metric][date]\r\n                                    }\r\n                                    const name = geo.properties[currentMap.name_key[lang]]\r\n                                    let isCurrentRegion =\r\n                                        geo.properties[currentMap.name_key.zh] ===\r\n                                        currentRegion[currentRegion.length - 1]\r\n                                    if (currentMap.parent_key)\r\n                                        isCurrentRegion =\r\n                                            isCurrentRegion &&\r\n                                            geo.properties[currentMap.parent_key] ===\r\n                                                currentRegion[currentRegion.length - 2]\r\n\r\n                                    // highlight all cities in the province\r\n                                    let isParentRegion = false\r\n                                    if (currentMap.parent_key) {\r\n                                        isParentRegion =\r\n                                            geo.properties[currentMap.parent_key] ===\r\n                                            currentRegion[currentRegion.length - 1]\r\n                                        if (currentRegion.length >= 3)\r\n                                            isParentRegion =\r\n                                                isParentRegion ||\r\n                                                geo.properties[currentMap.parent_key] ===\r\n                                                    currentRegion[currentRegion.length - 2]\r\n                                        if (\r\n                                            currentRegion.length === 1 ||\r\n                                            currentRegion[currentRegion.length - 1] === str.MAINLAND_CHINA_ZH\r\n                                        )\r\n                                            isParentRegion = true\r\n                                        isParentRegion = isParentRegion || isCurrentRegion\r\n                                    } else {\r\n                                        isParentRegion = true\r\n                                    }\r\n\r\n                                    const strokeColor =\r\n                                        counts === 0 ? greyStrokeColor : this.getStrokeColor(counts, isUsState)\r\n\r\n                                    // US map\r\n                                    if (this.props.currentMap === str.US_MAP2 && !isParentRegion) return <div />\r\n\r\n                                    return (\r\n                                        <Fragment key={`fragment-${geo.rsmKey}`}>\r\n                                            <Geography\r\n                                                key={geo.rsmKey}\r\n                                                className=\"map-geography\"\r\n                                                geography={geo}\r\n                                                data-tip={`${name} <span class=\"plot-tooltip-bold\">${counts}</span>`}\r\n                                                style={{\r\n                                                    default: {\r\n                                                        fill: isCurrentRegion\r\n                                                            ? `url(\"#highlightLines-${i}\") ${greyStrokeColor}`\r\n                                                            : counts > 0 ? colorScale(counts) : 'url(\"#lines\")',\r\n                                                        stroke: strokeColor,\r\n                                                        strokeWidth: isCurrentRegion ? 1 : 0,\r\n                                                        opacity: isParentRegion ? 1 : 0.2\r\n                                                    },\r\n                                                    hover: {\r\n                                                        fill: `url(\"#highlightLines-${i}\") ${greyStrokeColor}`,\r\n                                                        strokeWidth: 1,\r\n                                                        stroke: strokeColor,\r\n                                                        cursor: counts > 0 ? 'pointer' : 'default'\r\n                                                    },\r\n                                                    pressed: {\r\n                                                        fill: `url(\"#highlightLines-${i}\") ${greyStrokeColor}`,\r\n                                                        strokeWidth: 1,\r\n                                                        stroke: strokeColor,\r\n                                                        cursor: counts > 0 ? 'pointer' : 'default'\r\n                                                    }\r\n                                                }}\r\n                                                onClick={this.handleGeographyClick(geo.properties.REGION)}\r\n                                            />\r\n                                            <PatternLines\r\n                                                id={`highlightLines-${i}`}\r\n                                                height={6}\r\n                                                width={6}\r\n                                                stroke={strokeColor}\r\n                                                strokeWidth={1}\r\n                                                background={\r\n                                                    counts !== 0 ? (\r\n                                                        colorScale(counts)\r\n                                                    ) : darkMode ? (\r\n                                                        'var(--darker-grey)'\r\n                                                    ) : (\r\n                                                        '#fff'\r\n                                                    )\r\n                                                }\r\n                                                orientation={[ 'diagonal' ]}\r\n                                            />\r\n                                        </Fragment>\r\n                                    )\r\n                                })}\r\n                        </Geographies>\r\n                        {this.props.currentMap === str.WORLD_MAP &&\r\n                            this.state.showTransmissions &&\r\n                            transmissions\r\n                                .filter((trans) => parseDate(trans.date) <= parseDate(date))\r\n                                .map((trans, i) => {\r\n                                    return (\r\n                                        <Line\r\n                                            keys={`transmission-${i}`}\r\n                                            from={coord[trans.from].split(',').map((c) => parseFloat(c))}\r\n                                            to={coord[trans.to].split(',').map((c) => parseFloat(c))}\r\n                                            stroke={darkMode ? 'rgba(222,73,104,0.9)' : 'rgba(222, 73, 104, 0.5)'}\r\n                                            strokeWidth={1}\r\n                                            strokeLinecap=\"round\"\r\n                                            style={{\r\n                                                pointerEvents: 'none'\r\n                                            }}\r\n                                        />\r\n                                    )\r\n                                })}\r\n                        {[ str.WORLD_MAP, str.CHINA_MAP1, str.CHINA_MAP2 ].includes(this.props.currentMap) && (\r\n                            <Marker key={'wuhan'} coordinates={[ 114.2, 30.3 ]}>\r\n                                <g\r\n                                    fill=\"none\"\r\n                                    stroke=\"var(--primary-color-4)\"\r\n                                    strokeWidth=\"2\"\r\n                                    pointerEvents=\"none\"\r\n                                    strokeLinecap=\"round\"\r\n                                    strokeLinejoin=\"round\"\r\n                                    transform=\"translate(-12, -24)\"\r\n                                >\r\n                                    <circle cx=\"12\" cy=\"10\" r=\"3\" />\r\n                                    <path d=\"M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z\" />\r\n                                </g>\r\n                            </Marker>\r\n                        )}\r\n                        {(this.props.currentMap === str.WORLD_MAP || this.props.currentMap === str.JAPAN_MAP) && (\r\n                            <Marker key={'diamond-princess'} coordinates={[ 139.6, 35.4 ]}>\r\n                                <FaShip\r\n                                    size={this.props.currentMap === str.WORLD_MAP ? 18 : 36}\r\n                                    color={colorScale(cruiseCounts)}\r\n                                    className=\"map-ship\"\r\n                                    data-tip={`${lang === 'zh'\r\n                                        ? str.DIAMOND_PRINCESS_ZH\r\n                                        : cruiseData.ENGLISH} <span class=\"plot-tooltip-bold\">${cruiseCounts}</span>`}\r\n                                    style={{\r\n                                        stroke: cruiseStrokeColor,\r\n                                        visibility: cruiseCounts > 0 ? 'visible' : 'hidden',\r\n                                        strokeWidth:\r\n                                            currentRegion[currentRegion.length - 1] === str.DIAMOND_PRINCESS_ZH ? 30 : 0\r\n                                    }}\r\n                                    onClick={() =>\r\n                                        this.props.regionToggle([ str.INTL_CONVEYANCE_ZH, str.DIAMOND_PRINCESS_ZH ])}\r\n                                />\r\n                            </Marker>\r\n                        )}\r\n                    </ZoomableGroup>\r\n                </ComposableMap>\r\n            </Fragment>\r\n        )\r\n    }\r\n}\r\n\r\nexport default Map\r\n"]},"metadata":{},"sourceType":"module"}